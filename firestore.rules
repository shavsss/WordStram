rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      // Allow read/write only to the authenticated user who owns the document
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Deny deletion of the user document
      allow delete: if false;
      
      // Validate data on create
      allow create: if request.auth != null && 
                      request.auth.uid == userId && 
                      validUserCreate(request.resource.data);
      
      // Validate data on update
      allow update: if request.auth != null && 
                      request.auth.uid == userId && 
                      validUserUpdate(request.resource.data);
      
      // Validate user document creation
      function validUserCreate(data) {
        return 
          // Required fields
          data.email is string &&
          data.displayName is string &&
          data.paid is bool &&
          data.createdAt is timestamp &&
          
          // Array fields must be arrays
          (data.words is list || !('words' in data)) &&
          (data.notes is list || !('notes' in data)) &&
          (data.history is list || !('history' in data)) &&
          (data.chats is list || !('chats' in data)) &&
          
          // Stats must be an object
          (data.stats is map || !('stats' in data)) &&
          
          // User can't set themselves as paid
          data.paid == false;
      }
      
      // Validate user document updates
      function validUserUpdate(data) {
        return 
          // Required fields
          data.email is string &&
          data.displayName is string &&
          
          // Array fields must be arrays
          (data.words is list || !('words' in data)) &&
          (data.notes is list || !('notes' in data)) &&
          (data.history is list || !('history' in data)) &&
          (data.chats is list || !('chats' in data)) &&
          
          // Stats must be an object
          (data.stats is map || !('stats' in data)) &&
          
          // User can't change their paid status
          (!('paid' in request.resource.data) || 
           request.resource.data.paid == resource.data.paid);
      }
    }
    
    // Global settings or public data
    match /settings/{setting} {
      // Anyone can read global settings
      allow read: if request.auth != null;
      
      // Only admins can write settings
      allow write: if false; // Changed in admin functions
    }
    
    // Admin-only collections
    match /admin/{document=**} {
      allow read, write: if false; // Changed in admin functions
    }
  }
} 
} 